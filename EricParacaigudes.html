<html>
    
    <canvas id="canvas" width = "400" height = "600"></canvas>
    <script src="CanvasInput.min.js"></script>
    
    <form id="form" onsubmit="return false;">
        <input style="position:absolute; top:130; left:50; width:107;" type="text" id="userInput" />
        <input style="position:absolute; top:155; left:57; width:91;" type="submit" onclick="simula();" />
    </form>
    
    <script>
        
        var tint = 0.1;
        var t = 0;
        var Ttot = 0;
        var v = 0;
        var hf = 0;
        var X = 0;
        var final = false;
        const G = 9.81;
        const Tmar = 16;
        const m = 50;
        var Cd = 0.8;
        var A = 0.6;
        var desplegat = false;
        var haentratalt = false;
        var input;
        var h = 0;
        var hpar = 0;
        var comencat = false;
        
        function simula() {
            input = document.getElementById("userInput").value;
            h = input;
            t = 0;
            Ttot = 0;
            v = 0;
            X = 0;
            final = false;
            Cd = 0.8;
            A = 0.6;
            desplegat = false;
            if (!comencat) ferTot();
        }
    
    
        
        function calculaVlim(m, Cd, A, ro) {
            var vlim = Math.sqrt((2*G*m)/(Cd*ro*A));
            return vlim;
        }
        
        /*function calculaV(v) {
            var vres = G*(1-Math.pow(v/vlin, 2))*tint + v;
            return  vres;
        }*/
    
        function calculaV(Vlim, t, v) {
            var fe = Math.exp(-(2*G*tint)/Vlim);
            var Num = fe*(Vlim - v) - (Vlim + v);
            var Den = fe*(v - Vlim) - (Vlim + v);
            return Vlim*(Num/Den);
        }
    
        function calculaRo(h) {
            var Tem = Tmar - 0.00649*h;
            var P = 101.29*(Math.pow(((Tem + 273.1)/288.08), 5.256));
            var ro = P/(0.2869*(Tem + 273.1));
            return ro;
        }
    
        window.onload = function() {
            can = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            ctx.fillStyle = 'black';
            ctx.fillRect(0,0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.font = "15pt Verdana";
            ctx.fillText("SIMULADOR DE CAIGUDA LLIURE",33,70);
            ctx.font = "10pt Arial";
            ctx.fillText("Introdueix h inical",43,115);
            ctx.fillText("Autor: Daniel Vilardell",200,400);
            
            canvas.addEventListener('mousedown',handleMouseClick);
        }
    
        function ferTot() {
            comencat = true;
            setInterval(function() {
                if (!final) dibuixaTot();
                else {
                    ctx.fillStyle = 'black';
                    ctx.fillRect(0,0, canvas.width, canvas.height);
                    ctx.fillStyle = 'white';
                    ctx.fillText("Varia la h inical si vols!",40,115);
                    ctx.fillText("Clica per a tornar a simular",120,220);
                    ctx.font = "10pt Arial";
                    ctx.fillText("v final: " + parseFloat(v).toFixed(2) + "m/s" ,40,300);
                    ctx.fillText("h al desplegar el paracaigudes: " + parseFloat(hpar).toFixed(2) + "m",40,318);
                    ctx.fillText("t final: " + parseFloat(t).toFixed(2) + "s" ,40,336);
                }
            }, 100);
        }
    
        function dibuixaTot() {
            
            ctx.fillStyle = 'black';
            ctx.fillRect(0,0, canvas.width, canvas.height);
            dibuixaAltures();
            ctx.fillRect(0,550, 400, 3);
            X += v*tint;
            var ro = calculaRo(h-X);
            var vlim = calculaVlim(m, Cd, A, ro);
            v = calculaV(vlim, t, v);
            X += v*tint;
            t += tint;
            Ttot += tint;
            if (h - X > hf) {
                console.log(v);
                dibuixaCercle(230,50 + X/2*(1000/h) - 10, 10, 'white');
                ctx.font = "10pt Arial";
                ctx.fillText("Velositat: " + parseFloat(v).toFixed(2) + " m/s",40,40)
                ctx.fillText("Altura: " + parseFloat(h - X).toFixed(2) + " m",40,60)
                ctx.fillText("Temps: " + parseFloat(Ttot).toFixed(2) + " s",40,80)
                ctx.font = "8pt Arial";
                if (!desplegat) {
                    ctx.fillText("Clica per a desplegar ",40,200);
                    ctx.fillText("el paracaigudes!",50,215);
                }
                else {
                    ctx.fillText("Paracaigudes desplegat!",40,200);
                }
            }
            else final = true;

        }
    
    function dibuixaCercle(centerX, centerY, radius, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI*2, true);
        ctx.fill();
    }
    
    function dibuixaAltures() {
        for(var i = 0; i < 10; i++) {
            ctx.fillStyle = 'white';
            ctx.fillRect(330, 50*i + 50, 10, 2);
            ctx.font = "8pt Arial";
            ctx.fillText(h - i*h/10  + " m",350,50*i + 54);
        }
        
    }
    
    function handleMouseClick(evt) {
        if(!final) {
            desplegat = true;
            Cd=1.5;
            A=28;
            t = 0;
            hpar = h - X;
        }
        if(final) {
            desplegat = false;
            final = false;
            X = 0;
            t = 0;
            Ttot = 0;
            Cd = 0.8;
            A = 0.6;
            v = 0;
            hpar = 0;
        }
    }
    
        
    </script>
    
    
</html>
