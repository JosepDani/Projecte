<html>
	
	<canvas id="backgroundCanvas" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
	<canvas id="mapaCanvas" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
	<canvas id="heroiCanvas" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 2;"></canvas>

<!--el style es CSS i el z-index defineix en quina posicio esta el canvas, com mes alt, mes endevant esta (per sobre dels altres)-->

	<script src="Quadrat.js" type="text/javascript"></script>
	<script src="Punt.js" type="text/javascript"></script>
	<script src="Mapa.js" type="text/javascript"></script>
	<script src="Mapes.js" type="text/javascript"></script>

	<script type="text/javascript">

		var WIDTH = 600;
		var HEIGHT = 600;
		var backgroundCanvas;
		var mapaCanvas;
		var heroiCanvas;
		var ctxb; //context del background
		var ctxm; //context del mapa
		var ctxh; //context de l'heroi
		var MIDAQUADRAT = 15;
		var DELTAPOS = 2; //Augment de la posicio cada interval si esta clicant
		var posX = 60;
		var posY = 295;
		var keyState = {};
		var mapa = 1;

		window.onload = function() {
			inicialitza();
			mapes = new Mapes();
			dibuixaMapa();
			gameLoop();
		}

		function gameLoop() {
		    drawEverything();
		    mouTot();
		    setTimeout(gameLoop, 10);
		}

		//MOU TOT

		function mouTot() {
			mouQuadrat();
		}

		//MOU QUADRAT

		//https://stackoverflow.com/questions/12273451/how-to-fix-delay-in-javascript-keydown
		window.addEventListener('keydown',function(e){
    		keyState[e.keyCode || e.which] = true;
		},true);
		window.addEventListener('keyup',function(e){
   	 		keyState[e.keyCode || e.which] = false;
		},true);

		//Sembla molt farragos pero lunic que mira es si toquen les cantonades
		function mouQuadrat() {
			p = new Punt(heroi.p.x, heroi.p.y);
			if ((!heroi.estaTocantDE(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT) 
				|| !heroi.estaTocantBE(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)) 
				&& keyState[37]) p.x = heroi.p.x - DELTAPOS;
			if ((!heroi.estaTocantDD(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT) 
				|| !heroi.estaTocantDE(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)) 
				&& keyState[38]) p.y = heroi.p.y - DELTAPOS;
			if ((!heroi.estaTocantDD(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT) 
				|| !heroi.estaTocantBD(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)) 
				&& keyState[39]) p.x = heroi.p.x + DELTAPOS;
			if ((!heroi.estaTocantBD(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT) 
				|| !heroi.estaTocantBE(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)) 
				&& keyState[40]) p.y = heroi.p.y + DELTAPOS;
			heroi.p = p;
		}

		//DIBUIX DEL CANVAS
		function drawEverything() {
			heroi.dibuix();
		}

		function dibuixaMapa() {
			mapes.mapa(mapa).dibuixa();
		}

		function colorRectHeroi(posX, posY, width, height) {
			// lo de -MIDAQUADRAT/2 es per fer que es borri millor
   			ctxh.fillRect(posX, posY, width, height);
		}

		function colorRectMapa(posX, posY, width, height) {
			// lo de -MIDAQUADRAT/2 es per fer que es borri millor
   			ctxm.fillRect(posX, posY, width, height);
		}

		//INICIALITZACIO DE COSES
		function inicialitza() {
			backgroundCanvas = document.getElementById('backgroundCanvas');
			mapaCanvas = document.getElementById('mapaCanvas');
			heroiCanvas = document.getElementById('heroiCanvas');
			ctxb = backgroundCanvas.getContext('2d');
			ctxm = mapaCanvas.getContext('2d');
			ctxh = heroiCanvas.getContext('2d');

			const backgroundimg = new Image();
			backgroundimg.src = "https://images.designtrends.com/wp-content/uploads/2016/04/11094936/White-and-Grey-Grid-Pattern.jpg";
			backgroundimg.onload = function() {ctxb.drawImage(backgroundimg,0,0,backgroundCanvas.width,backgroundCanvas.height);}
			//es necessita el onload pq si no a vegades s'executa el drawImage() sense que es carregui
			//la imatge i llavors no surt res pq no es torna a cridar drawImage()
			ctxm.fillStyle = 'black'; //aixo es del context del mapa pq vegis com NO es borra
			ctxm.fillRect(0,0,600,600);

			ctxh.fillStyle = 'red'; //el fillStyle es defineix un cop i aixi no cal fer-ho a cada iteracio (no canvia)

			heroi = new Quadrat();
			heroi.p = new Punt(posX, posY);
		}

	</script>

</html>
