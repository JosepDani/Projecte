<html>
	<canvas id="backgroundCanvas" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
	<canvas id="mapaCanvas" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
	<canvas id="heroiCanvas" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 2;"></canvas>

<!--el style es CSS i el z-index defineix en quina posicio esta el canvas, com mes alt, mes endevant esta (per sobre dels altres)-->

	<script src="Quadrat.js" type="text/javascript"></script>
	<script src="Punt.js" type="text/javascript"></script>
	<script src="Mapa.js" type="text/javascript"></script>

	<script type="text/javascript">

		var WIDTH = 600;
		var HEIGHT = 600;
		var backgroundCanvas;
		var mapaCanvas;
		var heroiCanvas;
		var ctxb; //context del background
		var ctxm; //context del mapa
		var ctxh; //context de l'heroi
		var MIDAQUADRAT = 15;
		var DELTAPOS = 2; //Augment de la posicio cada interval si esta clicant
		var posX = 60;
		var posY = 295;
		var keyState = {};

		window.onload = function() {
			inicialitza();
			dibuixaMapa();
			gameLoop();
		}

		function gameLoop() {
		    drawEverything();
		    mouTot();
		    setTimeout(gameLoop, 10);
		}

		//MOU TOT

		function mouTot() {
			mouQuadrat();
		}

		//MOU QUADRAT

		//https://stackoverflow.com/questions/12273451/how-to-fix-delay-in-javascript-keydown
		window.addEventListener('keydown',function(e){
    		keyState[e.keyCode || e.which] = true;
		},true);
		window.addEventListener('keyup',function(e){
   	 		keyState[e.keyCode || e.which] = false;
		},true);

		function mouQuadrat() {
			p = new Punt(heroi.p.x, heroi.p.y);
			if ((!estaTocantDE() || !estaTocantBE()) && keyState[37]) p.x = heroi.p.x - DELTAPOS;
			if ((!estaTocantDD() || !estaTocantDE()) && keyState[38]) p.y = heroi.p.y - DELTAPOS;
			if ((!estaTocantDD() || !estaTocantBD()) && keyState[39]) p.x = heroi.p.x + DELTAPOS;
			if ((!estaTocantBD() || !estaTocantBE()) && keyState[40]) p.y = heroi.p.y + DELTAPOS;
			heroi.p = p;
			console.log(estaTocantDD());
		}

		function estaTocantDE() {
			if (heroi.p.y - DELTAPOS < mapa.zonaJoc[0].y
				|| heroi.p.x - DELTAPOS < mapa.zonaJoc[0].x) return true;
			for (var i = 0; i < mapa.zonaNoJoc.length - 1; i += 2) {
				if (heroi.p.x - DELTAPOS < mapa.zonaNoJoc[i].x + mapa.zonaNoJoc[i + 1].x
					&& heroi.p.y - DELTAPOS < mapa.zonaNoJoc[i].y + mapa.zonaNoJoc[i + 1].y
					&& heroi.p.x + MIDAQUADRAT> mapa.zonaNoJoc[i].x
					&& heroi.p.y + MIDAQUADRAT > mapa.zonaNoJoc[i].y) return true;
			}
			return false;
		}
		function estaTocantDD() {
			if(heroi.p.x + MIDAQUADRAT + DELTAPOS > mapa.zonaJoc[0].x + mapa.zonaJoc[1].x
				|| heroi.p.y - DELTAPOS < mapa.zonaJoc[0].y) return true;
			for (var i = 0; i < mapa.zonaNoJoc.length - 1; i += 2) {
				if (heroi.p.x + DELTAPOS + MIDAQUADRAT > mapa.zonaNoJoc[i].x
					&& heroi.p.y - DELTAPOS < mapa.zonaNoJoc[i].y + mapa.zonaNoJoc[i + 1].y
					&& heroi.p.y + MIDAQUADRAT > mapa.zonaNoJoc[i].y
					&& heroi.p.x < mapa.zonaNoJoc[i].x + mapa.zonaNoJoc[i + 1].x) return true;
			}
			return false;
		}

		function estaTocantBE() {
			if (heroi.p.x - DELTAPOS < mapa.zonaJoc[0].x
				|| heroi.p.y + MIDAQUADRAT + DELTAPOS > mapa.zonaJoc[0].y + mapa.zonaJoc[1].y) return true;
			for (var i = 0; i < mapa.zonaNoJoc.length - 1; i += 2) {
				if (heroi.p.x - DELTAPOS < mapa.zonaNoJoc[i].x + mapa.zonaNoJoc[i + 1].x
					&& heroi.p.y + DELTAPOS + MIDAQUADRAT > mapa.zonaNoJoc[i].y
					&& heroi.p.x + MIDAQUADRAT > mapa.zonaNoJoc[i].x
					&& heroi.p.y < mapa.zonaNoJoc[i].y + mapa.zonaNoJoc[i + 1].y
					) return true;
			}
			return false;
		}

		function estaTocantBD() {
			if (heroi.p.x + MIDAQUADRAT + DELTAPOS > mapa.zonaJoc[0].x + mapa.zonaJoc[1].x
				|| heroi.p.y + MIDAQUADRAT + DELTAPOS > mapa.zonaJoc[0].y + mapa.zonaJoc[1].y) return true;
			for (var i = 0; i < mapa.zonaNoJoc.length - 1; i += 2) {
				if (heroi.p.x + DELTAPOS + MIDAQUADRAT > mapa.zonaNoJoc[i].x
					&& heroi.p.y + DELTAPOS + MIDAQUADRAT > mapa.zonaNoJoc[i].y
					&& heroi.p.x < mapa.zonaNoJoc[i].x + mapa.zonaNoJoc[i + 1].x
					&& heroi.p.y < mapa.zonaNoJoc[i].y + mapa.zonaNoJoc[i + 1].y) return true;
			}
			return false;
		}

		//DIBUIX DEL CANVAS
		function drawEverything() {
			heroi.dibuix();
		}

		function dibuixaMapa() {
			mapa = new Mapa();
			mapa.zonaJoc = [new Punt(50, 200), new Punt(500, 200)];
			mapa.zonaNoJoc = [new Punt(50, 200), new Punt(50, 70), 
							  new Punt(50, 330), new Punt(50, 70), 
							  new Punt(200, 200), new Punt(50, 150),
							  new Punt(400, 250), new Punt(50, 150),
							  new Punt(500, 200), new Punt(50, 70), 
							  new Punt(500, 330), new Punt(50, 70),
							  new Punt(130, 240), new Punt(20, 20)];
			mapa.dibuixa();
		}

		function colorRectHeroi(posX, posY, width, height) {
			// lo de -MIDAQUADRAT/2 es per fer que es borri millor
   			ctxh.fillRect(posX, posY, width, height);
		}

		function colorRectMapa(posX, posY, width, height) {
			// lo de -MIDAQUADRAT/2 es per fer que es borri millor
   			ctxm.fillRect(posX, posY, width, height);
		}

		//INICIALITZACIO DE COSES
		function inicialitza() {
			backgroundCanvas = document.getElementById('backgroundCanvas');
			mapaCanvas = document.getElementById('mapaCanvas');
			heroiCanvas = document.getElementById('heroiCanvas');
			ctxb = backgroundCanvas.getContext('2d');
			ctxm = mapaCanvas.getContext('2d');
			ctxh = heroiCanvas.getContext('2d');

			const backgroundimg = new Image();
			backgroundimg.src = "https://images.designtrends.com/wp-content/uploads/2016/04/11094936/White-and-Grey-Grid-Pattern.jpg";
			backgroundimg.onload = function() {ctxb.drawImage(backgroundimg,0,0,backgroundCanvas.width,backgroundCanvas.height);}
			//es necessita el onload pq si no a vegades s'executa el drawImage() sense que es carregui
			//la imatge i llavors no surt res pq no es torna a cridar drawImage()
			ctxm.fillStyle = 'black'; //aixo es del context del mapa pq vegis com NO es borra
			ctxm.fillRect(0,0,600,600);

			ctxh.fillStyle = 'red'; //el fillStyle es defineix un cop i aixi no cal fer-ho a cada iteracio (no canvia)

			heroi = new Quadrat();
			heroi.p = new Punt(posX, posY);
		}

	</script>

</html>
