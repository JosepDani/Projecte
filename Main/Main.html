<html>

	<canvas id="backgroundCanvas" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
	<canvas id="mapaCanvas" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
	<canvas id="heroiCanvas" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 2;"></canvas>
	<canvas id="pilotaCanvas" width="600" height="600" style="position: absolute; left: 0; top: 0; z-index: 3;"></canvas>

<!--el style es CSS i el z-index defineix en quina posicio esta el canvas, com mes alt, mes endevant esta (per sobre dels altres)-->

	<script src="./Classes/Quadrat.js" type="text/javascript"></script>
	<script src="./Classes/Punt.js" type="text/javascript"></script>
	<script src="./Classes/Mapa.js" type="text/javascript"></script>
	<script src="./Classes/Mapes.js" type="text/javascript"></script>
	<script src="./Classes/Pilota.js" type="text/javascript"></script>
	<script src="Trajectories.js" type="text/javascript"></script>

	<script type="text/javascript">

		var WIDTH = 600;
		var HEIGHT = 600;
		var backgroundCanvas;
		var mapaCanvas;
		var heroiCanvas;
		var pilotesCanvas;
		var ctxb; //context del background
		var ctxm; //context del mapa
		var ctxh; //context de l'heroi
		var ctxp; //context pilotes
		var MIDAQUADRAT = 15;
		var DELTAPOS = 2; //Augment de la posicio cada interval si esta clicant
		var RPILOTES = 5;
		var posX = 60;
		var posY = 295;
		var keyState = {};
		var mapa = 1;

		window.onload = function() {
			inicialitza();
			dibuixaMapa();
			gameLoop();
		}

		function gameLoop() {
		    drawEverything();
		    mouTot();
		    setTimeout(gameLoop, 10);
		}

		//MOU TOT

		function mouTot() {
			mouQuadrat();
			//mapes.mapa(mapa).mouPilotes();
		}

	  //MOU QUADRAT

		//https://stackoverflow.com/questions/12273451/how-to-fix-delay-in-javascript-keydown
		window.addEventListener('keydown',function(e){
    		keyState[e.keyCode || e.which] = true;
		},true);
		window.addEventListener('keyup',function(e){
   	 		keyState[e.keyCode || e.which] = false;
		},true);

		//Sembla molt farragos pero lunic que mira es si toquen les cantonades
		function mouQuadrat() {
			if (keyState[37] //esquerra
				&& (!heroi.estaTocantDE(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)
				|| !heroi.estaTocantBE(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)))
				heroi.p.x = heroi.p.x - DELTAPOS;
			if (keyState[38] //dalt
				&& (!heroi.estaTocantDD(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)
				|| !heroi.estaTocantDE(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)))
				heroi.p.y = heroi.p.y - DELTAPOS;
			if (keyState[39] //dreta
				&& (!heroi.estaTocantDD(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)
				|| !heroi.estaTocantBD(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)))
				heroi.p.x = heroi.p.x + DELTAPOS;
			if (keyState[40] //baix
				&& (!heroi.estaTocantBD(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)
				|| !heroi.estaTocantBE(mapes.mapa(mapa), DELTAPOS, MIDAQUADRAT)))
				heroi.p.y = heroi.p.y + DELTAPOS;
			//console.log(heroi.estaTocantDE(mapa,DELTAPOS,MIDAQUADRAT));
		}

		//DIBUIX DEL CANVAS
		function drawEverything() {
			heroi.dibuix();
			mapes.mapa(mapa).dibuixaPilotes();
		}

		function dibuixaMapa() {
			mapes.mapa(mapa).dibuixa();
		}

		function drawCircle(centerX, centerY, radius, color) {
		    ctxp.fillStyle = color;
		    ctxp.beginPath();
		    ctxp.arc(centerX, centerY, radius, 0, Math.PI*2, true);
		    ctxp.fill();
		}

		//INICIALITZACIO DE COSES
		function inicialitza() {
			{//background
				backgroundCanvas = document.getElementById('backgroundCanvas');
				ctxb = backgroundCanvas.getContext('2d');
				const backgroundimg = new Image();
				backgroundimg.src = "https://images.designtrends.com/wp-content/uploads/2016/04/11094936/White-and-Grey-Grid-Pattern.jpg";
				backgroundimg.onload = function() {ctxb.drawImage(backgroundimg,0,0,backgroundCanvas.width,backgroundCanvas.height);}
				//es necessita el onload pq si no a vegades s'executa el drawImage() sense que es carregui
				//la imatge i llavors no surt res pq no es torna a cridar drawImage()
			}
			{//mapa
				mapaCanvas = document.getElementById('mapaCanvas');
				ctxm = mapaCanvas.getContext('2d');
				ctxm.fillStyle = 'black'; //aixo es del context del mapa pq vegis com NO es borra
				ctxm.fillRect(0,0,600,600);
				mapes = new Mapes();
			}
			{//Heroi
				heroiCanvas = document.getElementById('heroiCanvas');
				ctxh = heroiCanvas.getContext('2d');
				ctxh.fillStyle = 'red'; //el fillStyle es defineix un cop i aixi no cal fer-ho a cada iteracio (no canvia)
				heroi = new Quadrat(posX, posY);
			}
			{//Pilota
				pilotaCanvas = document.getElementById('pilotaCanvas');
				ctxp = pilotaCanvas.getContext('2d');
			}
		}

	</script>

</html>
